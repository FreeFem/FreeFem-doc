name: "Doc build (HTML & PDF)"

on: 
  push:
    branches:
      - master

jobs:
  build-doc:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@main
      
      - name: Install
        run: |
          sudo apt update
          sudo apt install nodejs npm
          sudo apt install texlive-latex-recommended texlive-fonts-recommended texlive-latex-extra
          pip install --upgrade pip
          pip install Sphinx
          pip install sphinxcontrib-inlinesyntaxhighlight
          pip install sphinx-sitemap
          git clone https://github.com/FreeFem/FreeFem-parser-pygments.git ~/pygments
          sudo cp ~/pygments/freefem.py /usr/lib/python3/dist-packages/pygments/lexers/
          (cd /usr/lib/python3/dist-packages/pygments/lexers/ && sudo python _mapping.py)
      
      - name: Build PDF
        run: |
          make latex
          (cd build/latex && pdflatex -halt-on-error -interaction=nonstopmode -jobname FreeFEM-documentation FreeFEM.tex && pdflatex -halt-on-error -interaction=nonstopmode -jobname FreeFEM-documentation FreeFEM.tex)

      - name: Build HTML
        run: |
          make html
          echo "doc.freefem.org" > build/html/CNAME
          mkdir build/html/pdf && cp build/latex/FreeFEM-documentation.pdf build/html/pdf/
          (cd build/html/pdf && md5sum FreeFEM-documentation.pdf >> FreeFEM-documentation.pdf.md5)
      
      - name: Deploy HTML
        uses: ad-m/github-push-action@master
        with:
          branch: gh-pages
          directory: build/html
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force: true
      
      - name: Deploy PDF
        uses: ad-m/github-push-action@master
        with:
          branch: pdf
          directory: build/latex
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force: true
